<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Livro AR — Carregamento Estável + Iluminação</title>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/",
        "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --glass-bg: rgba(20, 20, 25, 0.75);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text-main: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.7);
      --primary: #8b5cf6;
      /* Violet accent */
      --radius: 16px;
    }

    html,
    body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: 'Outfit', sans-serif;
      color: var(--text-main);
    }

    #ar {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      height: 100dvh;
      z-index: 1;
    }

    #ar>video,
    #ar>canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .ui {
      position: fixed;
      z-index: 20;
      user-select: none;
    }

    /* Loading Overlay */
    #loading {
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #050505;
      color: var(--text-main);
      gap: 1rem;
      transition: opacity 0.5s ease;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      100% {
        transform: rotate(360deg);
      }
    }

    /* Scanning Overlay */
    #scanningUI {
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: transparent;
    }

    .scanningBox {
      width: 65vmin;
      height: 65vmin;
      max-width: 400px;
      max-height: 400px;
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 20px;
      box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.6);
      /* Dim background */
      position: relative;
    }

    .scanningBox::after {
      content: "";
      position: absolute;
      inset: -4px;
      border-radius: 24px;
      border: 4px solid transparent;
      background: linear-gradient(45deg, var(--primary), transparent) border-box;
      -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0.5;
      animation: pulseBorder 2s infinite alternate;
    }

    .scan-label {
      position: absolute;
      bottom: -40px;
      left: 0;
      right: 0;
      text-align: center;
      font-weight: 500;
      letter-spacing: 0.5px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    }

    @keyframes pulseBorder {
      from {
        opacity: 0.3;
      }

      to {
        opacity: 0.8;
      }
    }

    /* Toolbar */
    #toolbar {
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 6px 8px;
      border-radius: var(--radius);
      border: 1px solid var(--glass-border);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      width: max-content;
      max-width: 90vw;
    }

    #toolbar button {
      background: transparent;
      border: none;
      color: var(--text-main);
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }

    #toolbar button:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    #toolbar button:active {
      transform: scale(0.95);
    }

    #toolbar button svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }

    #toolbar .page-control {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0 12px;
      border-left: 1px solid rgba(255, 255, 255, 0.1);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    #toolbar select {
      border: none;
      background: transparent;
      color: var(--text-main);
      text-align: center;
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      appearance: none;
      outline: none;
      padding-right: 1.2em;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right center;
      background-size: 16px;
    }

    #toolbar label {
      display: none;
    }

    /* Hide label text for cleaner look */

    #toolbar select option {
      background: #1a1a1a;
      color: #fff;
    }

    /* Badge */
    #badge {
      top: 20px;
      right: 20px;
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      padding: 8px 16px;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid var(--glass-border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body>
  <div id="ar"></div>

  <div id="loading" class="ui">
    <div class="spinner"></div>
    <div id="loadingText" style="margin-top:10px; font-weight:500;">Iniciando Experiência...</div>
  </div>

  <div id="scanningUI" class="ui">
    <div class="scanningBox">
      <div class="scan-label">Aponte para a página</div>
    </div>
  </div>

  <div id="toolbar" class="ui" style="display: none;">
    <button id="prevBtn" title="Anterior">
      <svg viewBox="0 0 24 24">
        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
      </svg>
    </button>
    <div class="page-control">
      <span style="font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;">Página</span>
      <select id="pageSel"></select>
    </div>
    <button id="nextBtn" title="Próxima">
      <svg viewBox="0 0 24 24">
        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
      </svg>
    </button>
  </div>

  <div id="badge" class="ui"></div>

  <script type="module">
    import * as THREE from "three";
    import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
    import { DRACOLoader } from "three/addons/loaders/DRACOLoader.js";
    import * as SkeletonUtils from "three/addons/utils/SkeletonUtils.js";
    import { RoomEnvironment } from "three/addons/environments/RoomEnvironment.js";
    import { MindARThree } from "mindar-image-three";

    const PAGES = [
      {
        label: "Capa", mind: "./targets/capa.mind", models: [
          { file: "./models/Capa.glb", portion: 1, pos: { x: 0, y: 0, z: 0 }, rot: { x: 0, y: 0, z: 0 } },]
      },
      { label: "1 • Fonte", mind: "./targets/pag01.mind", models: [{ file: "./models/anafonte.glb", portion: 1.2, pos: { x: 0, y: 0, z: 0 }, rot: { x: 0, y: 0, z: 0 } }] },
      { label: "2 • Ana", mind: "./targets/pag02.mind", models: [{ file: "./models/anafonte.glb", portion: 1.2, pos: { x: 0, y: 0, z: 0 }, rot: { x: 0, y: 0, z: 0 } }] },
      { label: "3 • Minerva", mind: "./targets/pag03.mind", models: [{ file: "./models/minervaearvore.glb", portion: 1.2, pos: { x: 0, y: 0, z: 0 }, rot: { x: 0, y: 0, z: 0 } }] },
      { label: "4 • Bailarinas", mind: "./targets/pag04.mind", models: [{ file: "./models/bailarinas.glb", portion: 1.2, pos: { x: 0, y: 0, z: 0 }, rot: { x: 0, y: 0, z: 0 } }] },
      { label: "5 • Ana Mapa", mind: "./targets/pag05.mind", models: [{ file: "./models/anamapa.glb", portion: 1.2, pos: { x: 0, y: 0, z: 0 }, rot: { x: 0, y: 0, z: 0 } }] },
      { label: "6 • Mapa", mind: "./targets/pag06.mind", models: [{ file: "./models/mapa.glb", portion: 1.2, pos: { x: 0, y: 0, z: 0 }, rot: { x: 0, y: 0, z: 0 } }] },
      { label: "7 • Baobá", mind: "./targets/pag07.mind", models: [{ file: "./models/baobaceninha.glb", portion: 1.2, pos: { x: 0, y: 0, z: 0 }, rot: { x: 0, y: 0, z: 0 } }] },
      { label: "8 • Recorte", mind: "./targets/pag08.mind", models: [{ file: "./models/recorte.glb", portion: 1.2, pos: { x: 0, y: 0, z: 0 }, rot: { x: 0, y: 0, z: 0 } }] },
      { label: "9 • Ana no Banco", mind: "./targets/pag09.mind", models: [{ file: "./models/ananobanco.glb", portion: 1.2, pos: { x: 0, y: 0, z: 0 }, rot: { x: 0, y: 0, z: 0 } }] },
      { label: "10 • Chave", mind: "./targets/pag10.mind", models: [{ file: "./models/chave.glb", portion: 1.2, pos: { x: 0, y: 0, z: 0 }, rot: { x: 0, y: 0, z: 0 } }] },
      { label: "11 • Ana e Avó", mind: "./targets/pag11.mind", models: [{ file: "./models/anaeavo.glb", portion: 1.2, pos: { x: 0, y: 0, z: 0 }, rot: { x: 0, y: 0, z: 0 } }] },
      { label: "12 • Fim", mind: "./targets/pag12.mind", models: [{ file: "./models/fim.glb", portion: 1.2, pos: { x: 0, y: 0, z: 0 }, rot: { x: 0, y: 0, z: 0 } }] }
    ];

    const DEFAULT_ROT_X = 0;
    const MINDAR_PARAMS = { filterMinCF: 0.0003, filterBeta: 0.005, warmupTolerance: 2, missTolerance: 3, maxTrack: 1, uiScanning: "#scanningUI" };

    const container = document.getElementById("ar"),
      loadingEl = document.getElementById("loading"),
      loadingTextEl = document.getElementById("loadingText") || document.getElementById("loading"),
      badgeEl = document.getElementById("badge"),
      sel = document.getElementById("pageSel"),
      prevBtn = document.getElementById("prevBtn"),
      nextBtn = document.getElementById("nextBtn"),
      scanningUI = document.getElementById("scanningUI"),
      toolbarEl = document.getElementById("toolbar");

    const loader = new GLTFLoader();
    const draco = new DRACOLoader(); draco.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/");
    loader.setDRACOLoader(draco);

    const modelCache = new Map();
    async function getModelClone(file) {
      if (!modelCache.has(file)) {
        const gltf = await loader.loadAsync(file);
        modelCache.set(file, gltf.scene);
      }
      // sempre retorna um clone independente
      return SkeletonUtils.clone(modelCache.get(file));
    }

    // Opcional: “aquecimento” do cache do navegador
    async function warmUpBrowserCache() {
      const all = new Set();
      for (const p of PAGES) {
        all.add(p.mind);
        for (const m of p.models) all.add(m.file);
      }
      for (const url of all) fetch(url).catch(() => { });
    }

    function fitCenterPlace(model, portion, pos, rot) {
      const box = new THREE.Box3().setFromObject(model);
      const center = new THREE.Vector3(); box.getCenter(center);
      model.position.sub(center);

      const group = new THREE.Group(); group.add(model);
      group.rotation.set(DEFAULT_ROT_X + (rot.x || 0), rot.y || 0, rot.z || 0);
      group.updateMatrixWorld(true);

      const sizedBox = new THREE.Box3().setFromObject(group);
      const size = new THREE.Vector3(); sizedBox.getSize(size);
      const scale = portion / Math.max(size.x, size.y, size.z || 1e-6);
      group.scale.multiplyScalar(scale);
      group.position.set(pos.x || 0, pos.y || 0, pos.z || 0);
      group.updateMatrixWorld(true);

      const finalBox = new THREE.Box3().setFromObject(group);
      group.position.z -= finalBox.min.z;
      return group;
    }

    let mindar = null;
    let currentIndex = 0;

    async function stopAndClear() {
      if (mindar) { try { await mindar.stop(); } catch { } }
      document.querySelectorAll('.mindar-ui-overlay').forEach(el => el.remove());
      container.innerHTML = ""; mindar = null;
      await new Promise(r => setTimeout(r, 50));
    }

    async function startPage(index) {
      currentIndex = index; sel.value = String(index);
      const cfg = PAGES[index]; badgeEl.textContent = cfg.label;

      loadingTextEl.textContent = "Abrindo câmera...";
      loadingEl.style.display = "flex";
      scanningUI.style.display = "none";

      await stopAndClear();

      mindar = new MindARThree({ container, imageTargetSrc: cfg.mind, ...MINDAR_PARAMS });
      const { renderer, scene, camera } = mindar;

      // ===== RENDERER PBR / SOMBRAS =====
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.0;
      renderer.physicallyCorrectLights = true;
      renderer.shadowMap.enabled = false;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;

      // ===== IBL (RoomEnvironment) + luz ambiente =====
      const pmrem = new THREE.PMREMGenerator(renderer);
      const envTex = pmrem.fromScene(new RoomEnvironment(), 0.04).texture;
      scene.environment = envTex;
      scene.background = null;
      scene.add(new THREE.HemisphereLight(0xffffff, 0x223344, 0.35));

      // ===== Anchor e rig de luzes preso ao alvo =====
      const anchor = mindar.addAnchor(0);

      const lightRig = new THREE.Group();
      anchor.group.add(lightRig);

      const key = new THREE.DirectionalLight(0xffffff, 1.35);
      key.position.set(0.8, 1.2, 0.8);
      key.castShadow = true;
      key.shadow.mapSize.set(1024, 1024);
      key.shadow.camera.near = 0.01;
      key.shadow.camera.far = 4.0;
      key.shadow.camera.left = -1; key.shadow.camera.right = 1;
      key.shadow.camera.top = 1; key.shadow.camera.bottom = -1;
      key.shadow.bias = -0.0005;
      key.shadow.normalBias = 0.02;
      lightRig.add(key);

      const fill = new THREE.DirectionalLight(0xffffff, 0.45);
      fill.position.set(-0.8, 0.8, 0.3);
      lightRig.add(fill);

      const rim = new THREE.DirectionalLight(0xffffff, 0.25);
      rim.position.set(0.0, 0.3, -0.8);
      lightRig.add(rim);

      // Plano receptor de sombra (tamanho ~ da página)
      const shadowPlane = new THREE.Mesh(
        new THREE.PlaneGeometry(1.2, 1.2),
        new THREE.ShadowMaterial({ opacity: 0.35 })
      );
      shadowPlane.receiveShadow = true;
      shadowPlane.renderOrder = 0;
      shadowPlane.position.z = 0.0002;
      anchor.group.add(shadowPlane);

      anchor.onTargetFound = () => { anchor.group.visible = true; scanningUI.style.display = "none"; };
      anchor.onTargetLost = () => { anchor.group.visible = false; scanningUI.style.display = "flex"; };

      anchor.group.visible = false;

      const onResize = () => {
        const w = container.clientWidth, h = container.clientHeight;
        renderer.setSize(w, h);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
        camera.aspect = w / h; camera.updateProjectionMatrix();
      };
      window.addEventListener("resize", onResize, { once: true }); onResize();
      renderer.setAnimationLoop(() => renderer.render(scene, camera));

      // Inicia a camera/scan antes de carregar GLB para evitar espera
      await mindar.start();
      loadingEl.style.display = "none";
      scanningUI.style.display = "flex";

      // ===== Modelos (assincrono, para nao travar camera) =====
      await Promise.all(cfg.models.map(async (modelCfg) => {
        const clone = await getModelClone(modelCfg.file);

        clone.traverse(n => {
          if (n.isMesh) n.castShadow = true;
        });

        const finalGroup = fitCenterPlace(clone, modelCfg.portion, modelCfg.pos, modelCfg.rot);
        anchor.group.add(finalGroup);
      }));
    }

    async function main() {
      PAGES.forEach((p, i) => {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = p.label;
        sel.appendChild(opt);
      });

      const urlP = Number(new URLSearchParams(location.search).get("p"));
      currentIndex = Number.isFinite(urlP) && urlP >= 0 && urlP < PAGES.length ? urlP : 0;

      loadingTextEl.textContent = `Carregando página ${currentIndex + 1}...`;
      await startPage(currentIndex);

      toolbarEl.style.display = "flex";
      warmUpBrowserCache().catch(() => { });

      prevBtn.onclick = () => startPage((currentIndex - 1 + PAGES.length) % PAGES.length);
      nextBtn.onclick = () => startPage((currentIndex + 1) % PAGES.length);
      sel.onchange = () => startPage(Number(sel.value));
    }

    main().catch(err => {
      console.error("Falha fatal ao iniciar a aplicação:", err);
      loadingTextEl.textContent = "Ocorreu um erro. Verifique o console.";
    });
  </script>
</body>

</html>