<script type="module">
  import * as THREE from "three";
  import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
  import { MindARThree } from "mindar-image-three";

  document.addEventListener("DOMContentLoaded", async () => {
    const loadingDiv = document.getElementById("loading");

    const mindarThree = new MindARThree({
      container: document.body,
      imageTargetSrc: "./targets/qr.mind",
      maxTrack: 1,
    });
    const { renderer, scene, camera } = mindarThree;

    const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
    scene.add(light);
    
    // ---- INÍCIO DO TESTE DO CUBO DE DEPURAÇÃO ----

    // 1. Criamos um cubo vermelho simples.
    const geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
    const material = new THREE.MeshBasicMaterial({ color: 0xff0000 }); // Vermelho brilhante
    const testCube = new THREE.Mesh(geometry, material);
    let cubePlaced = false;

    // ---- FIM DO TESTE DO CUBO DE DEPURAÇÃO ----


    // Carregamos o modelo 3D normalmente, mas não o usaremos por enquanto.
    const loader = new GLTFLoader();
    const anchor = mindarThree.addAnchor(0);
    let loadedModel = null;

    loader.load("./models/placeholder.glb", (gltf) => {
        console.log("Modelo 3D carregado, mas será ignorado para o teste.");
        loadedModel = gltf.scene; 
    });

    // Quando o alvo for encontrado...
    anchor.onTargetFound = () => {
      console.log("Alvo encontrado! Tentando exibir o CUBO VERMELHO.");

      // Se o cubo ainda não foi posicionado...
      if (!cubePlaced) {
        // 2. Adicionamos o CUBO VERMELHO diretamente à CENA.
        scene.add(testCube);

        // 3. Posicionamos o cubo 1 metro à frente da câmera (e um pouco abaixo).
        // Usamos a própria câmera como referência, ignorando a posição do QR Code.
        const cameraPosition = new THREE.Vector3();
        camera.getWorldPosition(cameraPosition);
        testCube.position.copy(cameraPosition);

        const cameraDirection = new THREE.Vector3();
        camera.getWorldDirection(cameraDirection);
        
        // Move o cubo na direção que a câmera está olhando
        testCube.position.add(cameraDirection.multiplyScalar(1)); // 1 metro à frente
        
        console.log("Cubo adicionado à cena na posição:", testCube.position);
        
        cubePlaced = true;
      }
    };

    await mindarThree.start();
    loadingDiv.style.display = "none";

    renderer.setAnimationLoop(() => {
      // 4. Se o cubo foi posicionado, fazemos ele girar.
      if (cubePlaced) {
        testCube.rotation.y += 0.01;
        testCube.rotation.x += 0.01;
      }
      renderer.render(scene, camera);
    });
  });
</script>