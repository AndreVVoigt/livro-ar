<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Livro AR com MindAR</title>

    <!-- Importmap -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/",
          "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
        }
      }
    </script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #000;
        overflow: hidden;
      }

      /* Container em tela cheia, seguro para mobile */
      #ar-container {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100dvh;   /* unidades dinâmicas evitam "salto" com barra do navegador */
        height: 100svh;   /* fallback para iOS */
        background: #000;
        overflow: hidden;
        touch-action: none;
      }

      /* Garanta que vídeo e canvas preencham o container */
      #ar-container > video,
      #ar-container > canvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;  /* elimina faixas pretas */
      }

      /* Overlay de carregamento */
      #loading {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: rgba(0, 0, 0, .5);
        z-index: 10;
      }
    </style>
  </head>

  <body>
    <div id="ar-container"></div>
    <div id="loading">Abrindo a câmera… autorize o uso.</div>

    <script type="module">
      import * as THREE from "three";
      import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
      import { MindARThree } from "mindar-image-three";

      // 1) Inicializa MindAR no container dedicado
      const container = document.querySelector("#ar-container");
      const mindarThree = new MindARThree({
        container,
        imageTargetSrc: "./targets/qr.mind",
        maxTrack: 1
      });

      const { renderer, scene, camera } = mindarThree;

      // Iluminação básica
      const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
      scene.add(hemi);

      // 2) Anchor do primeiro (e único) alvo do .mind
      const anchor = mindarThree.addAnchor(0);

      // 3) Cubo de debug ancorado (opcional)
      const debugCube = new THREE.Mesh(
        new THREE.BoxGeometry(0.2, 0.2, 0.2),
        new THREE.MeshNormalMaterial()
      );
      debugCube.visible = false;
      anchor.group.add(debugCube);

      // 4) Carregamento do modelo GLB e ancoragem
      const loader = new GLTFLoader();
      let model = null;

      loader.load(
        "./models/placeholder.glb",
        (gltf) => {
          model = gltf.scene;
          model.scale.set(0.3, 0.3, 0.3);   // ajuste fino conforme necessário
          model.position.set(0, 0, 0);      // centro do marcador
          model.rotation.set(0, 0, 0);
          model.visible = false;
          anchor.group.add(model);
          console.log("Modelo GLB carregado e ancorado.");
        },
        undefined,
        (err) => console.error("Erro ao carregar GLB:", err)
      );

      // 5) Mostrar/ocultar quando o alvo é detectado
      anchor.onTargetFound = () => {
        debugCube.visible = true;
        if (model) model.visible = true;
      };
      anchor.onTargetLost = () => {
        debugCube.visible = false;
        if (model) model.visible = false;
      };

      // 6) Início do AR e laço de renderização
      await mindarThree.start();
      document.getElementById("loading").style.display = "none";

      const onResize = () => {
        const w = container.clientWidth;
        const h = container.clientHeight;
        renderer.setSize(w, h);
        renderer.setPixelRatio(window.devicePixelRatio || 1);
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
      };
      window.addEventListener("resize", onResize);
      onResize();

      renderer.setAnimationLoop(() => {
        renderer.render(scene, camera);
      });
    </script>
  </body>
</html>
