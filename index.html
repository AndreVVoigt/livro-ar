<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Livro AR com MindAR</title>

    <!-- Importmap -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/",
          "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
        }
      }
    </script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #000;
        overflow: hidden;
      }

      /* Container em tela cheia, seguro para mobile */
      #ar-container {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100dvh;   /* unidades dinâmicas evitam "salto" com a barra do navegador */
        height: 100svh;   /* fallback para iOS */
        background: #000;
        overflow: hidden;
        touch-action: none;
      }

      /* Garanta que vídeo e canvas preencham o container */
      #ar-container > video,
      #ar-container > canvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;  /* elimina faixas pretas */
      }

      /* Overlay de carregamento */
      #loading {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: rgba(0, 0, 0, .5);
        z-index: 10;
      }
    </style>
  </head>

  <body>
    <div id="ar-container"></div>
    <div id="loading">Abrindo a câmera… autorize o uso.</div>

    <script type="module">
      import * as THREE from "three";
      import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
      import { DRACOLoader } from "three/addons/loaders/DRACOLoader.js";
      import { MindARThree } from "mindar-image-three";

      // 1) Inicializa MindAR no container dedicado
      const container = document.querySelector("#ar-container");
      const mindarThree = new MindARThree({
        container,
        imageTargetSrc: "./targets/page1.mind",
        maxTrack: 1,
        filterMinCF: 0.0005,   // mais baixo = mais suave
        filterBeta:   0.01,    // maior = responde mais rápido
        warmupTolerance: 2,    // evita falso positivo ao iniciar
        missTolerance:   2     // evita falso “perdeu alvo”
      });

      const { renderer, scene, camera } = mindarThree;

      // Iluminação (inclui sombra para contato)
      renderer.shadowMap.enabled = true;
      scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 0.6));

      const dir = new THREE.DirectionalLight(0xffffff, 1);
      dir.position.set(0.6, 1.2, 0.8);
      dir.castShadow = true;
      dir.shadow.mapSize.set(1024, 1024);
      scene.add(dir);

      // 2) Anchor do primeiro (e único) alvo do .mind
      const anchor = mindarThree.addAnchor(0);

      // (Opcional) Plano de oclusão e plano receptor de sombra ancorados à página
      const GROUND_SIZE = 1.0; // ~largura do alvo
      const occluder = new THREE.Mesh(
        new THREE.PlaneGeometry(GROUND_SIZE, GROUND_SIZE),
        new THREE.MeshBasicMaterial({ colorWrite: false })
      );
      occluder.renderOrder = 0;
      anchor.group.add(occluder);

      const shadowPlane = new THREE.Mesh(
        new THREE.PlaneGeometry(GROUND_SIZE, GROUND_SIZE),
        new THREE.ShadowMaterial({ opacity: 0.35 })
      );
      shadowPlane.receiveShadow = true;
      shadowPlane.position.z = 0.0002; // evita z-fighting
      shadowPlane.renderOrder = 1;
      anchor.group.add(shadowPlane);

      // 3) Cubo de debug ancorado (opcional)
      const debugCube = new THREE.Mesh(
        new THREE.BoxGeometry(0.2, 0.2, 0.2),
        new THREE.MeshNormalMaterial()
      );
      debugCube.visible = false;
      anchor.group.add(debugCube);

      // 4) Função utilitária: encaixa o modelo na página e "apoia" no plano (Z)
      const TARGET_PORTION = 0.35; // 35% da largura do alvo
      function fitAndPlaceOnPage(obj, portion = TARGET_PORTION) {
        obj.updateWorldMatrix(true, true);
        const box = new THREE.Box3().setFromObject(obj);
        const size = new THREE.Vector3();
        box.getSize(size);

        const maxXY = Math.max(size.x, size.y) || 1e-6;
        const s = portion / maxXY;
        obj.scale.multiplyScalar(s);

        // Recalcula e apoia no "chão"
        obj.updateWorldMatrix(true, true);
        const box2 = new THREE.Box3().setFromObject(obj);
        const heightZ = box2.max.z - box2.min.z;
        obj.position.set(0, 0, heightZ / 2 + 0.003);
      }

      // 5) Carregamento do modelo GLB (Minerva.glb) e ancoragem
      const loader = new GLTFLoader();

      // (Opcional) Caso Minerva.glb esteja comprimido com Draco
      const draco = new DRACOLoader();
      draco.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/");
      loader.setDRACOLoader(draco);

      let model = null;

      loader.load(
        "./models/Minerva.glb",
        (gltf) => {
          model = gltf.scene;

          // Habilita sombras
          model.traverse((n) => {
            if (n.isMesh) n.castShadow = true;
          });

          anchor.group.add(model);

          // Se vier “deitado”/virado, ajuste aqui:
          // model.rotation.x = -Math.PI / 2;
          // model.rotation.y = Math.PI;

          // Encaixa e apoia na página
          fitAndPlaceOnPage(model, 1); // ajuste 0.2–0.6 conforme preferir

          model.visible = false;
          console.log("Minerva.glb carregado, ancorado e posicionado.");
        },
        undefined,
        (err) => console.error("Erro ao carregar Minerva.glb:", err)
      );

      // 6) Mostrar/ocultar quando o alvo é detectado
      anchor.onTargetFound = () => {
        debugCube.visible = true;
        if (model) model.visible = true;
      };
      anchor.onTargetLost = () => {
        debugCube.visible = false;
        if (model) model.visible = false;
      };

      // 7) Início do AR e laço de renderização
      await mindarThree.start();
      document.getElementById("loading").style.display = "none";

      const onResize = () => {
        const w = container.clientWidth;
        const h = container.clientHeight;
        renderer.setSize(w, h);
        renderer.setPixelRatio(window.devicePixelRatio || 1);
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
      };
      window.addEventListener("resize", onResize);
      onResize();

      renderer.setAnimationLoop(() => {
        renderer.render(scene, camera);
      });
    </script>
  </body>
</html>
