<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8" />
    <title>Livro AR com MindAR</title>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/",
          "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
        }
      }
    </script>
    <style>
      html, body { margin:0; height:100%; overflow:hidden; background:#000; }
      #loading {
        position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
        color:#fff; font-family:sans-serif; background:rgba(0,0,0,.5)
      }
    </style>
  </head>
  <body>
    <div id="loading">Abrindo a câmera... autorize o uso.</div>

    <script type="module">
      import * as THREE from "three";
      import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
      import { MindARThree } from "mindar-image-three";

      const loadingDiv = document.getElementById("loading");

      // 1) Inicializa MindAR
      const mindarThree = new MindARThree({
        container: document.body,
        imageTargetSrc: "./targets/qr.mind",
        maxTrack: 1,
      });
      const { renderer, scene, camera } = mindarThree;

      // Luz básica
      scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1));

      // 2) Cria o anchor do alvo 0
      const anchor = mindarThree.addAnchor(0);

      // 3) Debug cube ANCORADO (útil para validar)
      const debugCube = new THREE.Mesh(
        new THREE.BoxGeometry(0.2, 0.2, 0.2),
        new THREE.MeshNormalMaterial()
      );
      debugCube.visible = false;
      anchor.group.add(debugCube);

      // 4) Carrega o modelo e ANEXA ao anchor
      const loader = new GLTFLoader();
      let model = null;
      loader.load(
        "./models/placeholder.glb",
        (gltf) => {
          model = gltf.scene;
          model.scale.set(0.3, 0.3, 0.3);     // ajuste fino conforme necessário
          model.position.set(0, 0, 0);        // centro do marcador
          model.visible = false;
          anchor.group.add(model);
          console.log("Modelo GLB carregado e anexado ao anchor.");
        },
        undefined,
        (err) => console.error("Erro ao carregar GLB:", err)
      );

      // 5) Reações ao tracking
      anchor.onTargetFound = () => {
        if (model) model.visible = true;
        debugCube.visible = true;
      };
      anchor.onTargetLost = () => {
        if (model) model.visible = false;
        debugCube.visible = false;
      };

      // 6) Start e render loop
      await mindarThree.start();
      loadingDiv.style.display = "none";

      renderer.setAnimationLoop(() => {
        renderer.render(scene, camera);
      });
    </script>
  </body>
</html>
